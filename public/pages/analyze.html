<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sage Stocks - Analyzer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Liquid Glass Design System - Dark Mode */
        :root {
            --glass-bg: rgba(30, 30, 40, 0.6);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-shadow: rgba(0, 0, 0, 0.5);

            /* Vibrant Color Palette - Dark Mode */
            --electric-blue: oklch(0.70 0.30 250);
            --electric-blue-fg: oklch(0.98 0 0);
            --neon-purple: oklch(0.68 0.30 290);
            --neon-purple-fg: oklch(0.98 0 0);
            --cyber-pink: oklch(0.75 0.28 340);
            --cyber-pink-fg: oklch(0.10 0 0);
            --tech-green: oklch(0.75 0.26 150);
            --tech-green-fg: oklch(0.10 0 0);
            --solar-orange: oklch(0.78 0.24 50);
            --solar-orange-fg: oklch(0.10 0 0);
            --sky-cyan: oklch(0.75 0.22 200);
            --sky-cyan-fg: oklch(0.10 0 0);
            --royal-indigo: oklch(0.62 0.26 270);
            --royal-indigo-fg: oklch(0.98 0 0);
            --crimson: oklch(0.68 0.28 20);
            --crimson-fg: oklch(0.98 0 0);

            /* Base colors */
            --background: oklch(0.145 0 0);
            --foreground: oklch(0.985 0 0);
            --muted-foreground: oklch(0.76 0 0);
            --accent: oklch(0.269 0 0);
        }

        body {
            background: linear-gradient(135deg, oklch(0.145 0 0) 0%, oklch(0.18 0.02 270) 100%);
            color: var(--foreground);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        /* Glass morphism utilities */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 var(--glass-shadow);
        }

        .glass-strong {
            background: var(--glass-bg);
            backdrop-filter: blur(40px);
            -webkit-backdrop-filter: blur(40px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 var(--glass-shadow);
        }

        /* Button styles */
        .btn-primary {
            background: var(--electric-blue);
            color: var(--electric-blue-fg);
            padding: 0.875rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px var(--electric-blue);
        }

        .btn-secondary {
            background: transparent;
            color: var(--foreground);
            padding: 0.875rem 2rem;
            border-radius: 0.75rem;
            font-weight: 600;
            border: 1px solid var(--glass-border);
            transition: all 0.3s ease;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--electric-blue);
        }

        .input-glass {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            color: var(--foreground);
            padding: 0.875rem 1rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }

        .input-glass:focus {
            outline: none;
            border-color: var(--electric-blue);
            box-shadow: 0 0 0 3px rgba(70, 150, 255, 0.1);
        }

        .input-glass::placeholder {
            color: var(--muted-foreground);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-active { background-color: var(--tech-green); }
        .status-error { background-color: var(--crimson); }
        .status-inactive { background-color: var(--muted-foreground); }

        .api-card {
            transition: all 0.3s ease;
        }
        .api-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
        }

        /* Spinner animation */
        .spinner {
            border: 3px solid var(--accent);
            border-top: 3px solid var(--electric-blue);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Top Nav Bar -->
    <nav class="glass-strong sticky top-0 z-50 border-b border-white/10">
        <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-[var(--electric-blue)] to-[var(--neon-purple)] flex items-center justify-center">
                    <span class="text-xl">‚õ∞Ô∏è</span>
                </div>
                <span class="text-lg font-medium">Sage Stocks</span>
            </div>
            <div class="flex items-center space-x-4">
                <span class="text-sm font-medium" style="color: var(--electric-blue);">Analyzer</span>
                <a href="/pages/settings.html" class="text-sm hover:text-[var(--electric-blue)] transition duration-200">
                    Settings
                </a>
                <button
                    onclick="window.location.href='/api/auth/logout'"
                    class="btn-secondary text-sm py-2 px-4"
                >
                    Logout
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="max-w-6xl mx-auto p-6 py-12">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-semibold mb-2">Stock Analyzer</h1>
            <p class="text-[var(--muted-foreground)] text-lg">Enter a ticker to get your Sage Intelligence-powered analysis</p>
        </div>

        <!-- Main Analyzer Section -->
        <div id="analyzer-section" class="glass-strong rounded-2xl p-8 mb-6">
            <h2 class="text-2xl font-medium mb-6">Stock Analyzer</h2>

            <!-- Ticker Input -->
            <div class="mb-6">
                <label for="ticker" class="block text-sm font-medium mb-2" style="color: var(--muted-foreground);">
                    Stock Ticker
                </label>
                <input
                    type="text"
                    id="ticker"
                    placeholder="e.g., AAPL, MSFT, NVDA"
                    class="input-glass w-full uppercase"
                    maxlength="10"
                />
            </div>

            <!-- Analyze Button -->
            <button
                id="analyze-btn"
                class="btn-primary w-full py-3 px-6"
            >
                Analyze Stock
            </button>

            <!-- Status Display -->
            <div id="status-display" class="mt-6 hidden">
                <div class="glass rounded-xl p-4">
                    <div class="flex items-center gap-3">
                        <div class="spinner"></div>
                        <p class="font-medium" style="color: var(--electric-blue);" id="status-text">Initializing analysis...</p>
                    </div>
                </div>
            </div>

            <!-- Results Display -->
            <div id="results-display" class="mt-6 hidden">
                <div class="glass rounded-xl p-6" style="border-color: var(--tech-green);">
                    <h3 class="text-lg font-semibold mb-3 flex items-center gap-2">
                        <span class="text-2xl">‚úÖ</span>
                        <span style="color: var(--tech-green);">Analysis Complete!</span>
                    </h3>
                    <p class="text-[var(--muted-foreground)] mb-4">
                        Your analysis has been saved to your Notion workspace.
                    </p>

                    <div class="flex flex-col sm:flex-row gap-3 mb-4">
                        <a
                            id="results-link"
                            href="#"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="btn-primary text-center"
                        >
                            üìÑ View This Analysis ‚Üí
                        </a>
                        <a
                            id="workspace-link"
                            href="#"
                            target="_blank"
                            rel="noopener noreferrer"
                            class="btn-secondary text-center"
                        >
                            üìä View Sage Stocks Workspace ‚Üí
                        </a>
                    </div>

                    <div class="text-sm text-[var(--muted-foreground)]">
                        <p class="mb-2">From your workspace, you can:</p>
                        <ul class="ml-4 space-y-1">
                            <li>‚Ä¢ Access your Stock Analyses and History databases</li>
                            <li>‚Ä¢ View AI-generated insights and recommendations</li>
                            <li>‚Ä¢ Track your portfolio performance over time</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Error Display -->
            <div id="error-display" class="mt-6 hidden">
                <div id="error-box" class="glass rounded-xl p-4">
                    <p id="error-text" class="whitespace-pre-line"></p>
                </div>
            </div>

            <!-- Usage Counter -->
            <div class="mt-6 text-center text-sm text-[var(--muted-foreground)]">
                <span id="usage-counter">Analyses today: <span class="font-semibold">0/10</span></span>
            </div>
        </div>

        <!-- Admin Panel (Hidden by default, shown with ?admin=true) -->
        <div id="admin-panel" class="hidden">
            <div class="glass-strong rounded-2xl p-8">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-medium">API Management Dashboard</h2>
                    <button
                        id="refresh-apis"
                        class="btn-secondary text-sm py-2 px-4"
                    >
                        Refresh
                    </button>
                </div>

                <!-- Loading State -->
                <div id="admin-loading" class="text-center py-12">
                    <div class="spinner mx-auto mb-4" style="width: 48px; height: 48px; border-width: 4px;"></div>
                    <p class="text-[var(--muted-foreground)]">Loading API status...</p>
                </div>

                <!-- API Status Cards -->
                <div id="api-status-container" class="hidden">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8" id="api-cards">
                        <!-- API cards will be inserted here dynamically -->
                    </div>

                    <!-- Daily Cost Summary -->
                    <div class="glass rounded-xl p-6">
                        <h3 class="text-lg font-semibold mb-4">Daily Cost Summary</h3>
                        <div id="cost-summary" class="space-y-2 text-sm">
                            <!-- Cost details will be inserted here -->
                        </div>
                    </div>
                </div>

                <!-- Last Updated -->
                <div class="mt-6 text-center text-sm text-[var(--muted-foreground)]">
                    Last updated: <span id="last-updated">Never</span>
                    <span class="mx-2">‚Ä¢</span>
                    Auto-refresh every 30s
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check authentication on page load
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/session');
                const data = await response.json();

                if (!data.authenticated) {
                    // Not authenticated - redirect to landing page
                    window.location.href = '/';
                    return false;
                }

                return true;
            } catch (error) {
                console.error('Auth check failed:', error);
                window.location.href = '/';
                return false;
            }
        }

        // Run auth check immediately
        checkAuth();

        // Check for admin parameter
        const urlParams = new URLSearchParams(window.location.search);
        const isAdmin = urlParams.get('admin') === 'true';

        if (isAdmin) {
            document.getElementById('admin-panel').classList.remove('hidden');
            loadAPIStatus();
            // Auto-refresh every 30 seconds
            setInterval(loadAPIStatus, 30000);
        }

        // Analyze button handler
        document.getElementById('analyze-btn').addEventListener('click', async () => {
            const ticker = document.getElementById('ticker').value.trim().toUpperCase();

            if (!ticker) {
                showError('Please enter a stock ticker', false);
                return;
            }

            if (!/^[A-Z0-9-]{1,10}$/.test(ticker)) {
                showError('Invalid ticker format. Use 1-10 alphanumeric characters and hyphens.', false);
                return;
            }

            // Reset displays
            hideAll();
            showStatus('Analyzing ' + ticker + '...');

            try {
                // Detect user's timezone automatically (v1.0.3)
                const userTimezone = Intl.DateTimeFormat().resolvedOptions().timeZone;

                const response = await fetch('/api/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        ticker: ticker,
                        timezone: userTimezone, // Send browser timezone for rate limiting and timestamps
                        // userId will be extracted from session by the API
                    }),
                });

                // Check if response is JSON before parsing
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    // Response is not JSON - read as text for error message
                    const text = await response.text();
                    const preview = text.substring(0, 200);
                    console.error('Non-JSON response from server:', preview);
                    showError(`Server error (${response.status}): ${preview.replace(/<[^>]*>/g, '').trim()}`, true);
                    return;
                }

                const data = await response.json();

                if (data.success) {
                    showResults(data.analysesPageId, data.sageStocksPageId);
                    updateUsageCounter(data.rateLimit);
                } else {
                    // Show actual error message from backend
                    const errorMsg = data.error?.message || data.error || 'Analysis failed';
                    const isUnexpected = data.error?.isUnexpected || false;
                    showError(errorMsg, isUnexpected);
                }
            } catch (error) {
                console.error('Analysis request failed:', error);
                showError('Request failed: ' + error.message, true);
            }
        });

        // Refresh button handler
        document.getElementById('refresh-apis')?.addEventListener('click', () => {
            loadAPIStatus();
        });

        function hideAll() {
            document.getElementById('status-display').classList.add('hidden');
            document.getElementById('results-display').classList.add('hidden');
            document.getElementById('error-display').classList.add('hidden');
        }

        function showStatus(message) {
            document.getElementById('status-text').textContent = message;
            document.getElementById('status-display').classList.remove('hidden');
        }

        function showResults(pageId, sageStocksPageId) {
            hideAll();

            // Set analysis page link
            const analysisLink = `https://notion.so/${pageId.replace(/-/g, '')}`;
            document.getElementById('results-link').href = analysisLink;

            // Set workspace link (v1.2.4)
            if (sageStocksPageId) {
                const workspaceLink = `https://notion.so/${sageStocksPageId.replace(/-/g, '')}`;
                document.getElementById('workspace-link').href = workspaceLink;
            } else {
                // Hide workspace link if not available
                document.getElementById('workspace-link').style.display = 'none';
            }

            document.getElementById('results-display').classList.remove('hidden');
        }

        function showError(message, isUnexpected = false) {
            hideAll();
            const errorTextEl = document.getElementById('error-text');
            const errorBox = document.getElementById('error-box');

            // Apply red/crimson styling for unexpected errors, blue for expected errors
            if (isUnexpected) {
                errorBox.style.borderColor = 'var(--crimson)';
                errorTextEl.style.color = 'var(--crimson)';
            } else {
                errorBox.style.borderColor = 'var(--electric-blue)';
                errorTextEl.style.color = 'var(--electric-blue)';
            }

            // Convert markdown links to HTML links
            // Pattern: [text](url)
            const linkColor = isUnexpected ? 'crimson' : 'electric-blue';
            const htmlMessage = message.replace(/\[([^\]]+)\]\(([^)]+)\)/g,
                `<a href="$2" class="underline font-medium" style="color: var(--${linkColor});" target="_blank">$1</a>`);

            errorTextEl.innerHTML = htmlMessage;
            document.getElementById('error-display').classList.remove('hidden');
        }

        function updateUsageCounter(rateLimit) {
            if (rateLimit) {
                const used = rateLimit.total - rateLimit.remaining;
                document.getElementById('usage-counter').innerHTML =
                    `Analyses today: <span class="font-semibold">${used}/${rateLimit.total}</span>`;
            }
        }

        async function loadAPIStatus() {
            const loading = document.getElementById('admin-loading');
            const container = document.getElementById('api-status-container');

            loading.classList.remove('hidden');
            container.classList.add('hidden');

            try {
                const response = await fetch('/api/api-status');
                const data = await response.json();

                if (data.success) {
                    renderAPICards(data.apis);
                    renderCostSummary(data.apis, data.summary);
                    document.getElementById('last-updated').textContent = new Date().toLocaleTimeString();

                    loading.classList.add('hidden');
                    container.classList.remove('hidden');
                } else {
                    showError('Failed to load API status');
                }
            } catch (error) {
                showError('Network error loading API status');
                loading.classList.add('hidden');
            }
        }

        function renderAPICards(apis) {
            const container = document.getElementById('api-cards');
            container.innerHTML = '';

            Object.entries(apis).forEach(([key, api]) => {
                const card = createAPICard(api);
                container.appendChild(card);
            });
        }

        function createAPICard(api) {
            const div = document.createElement('div');
            div.className = 'api-card glass rounded-xl p-6';

            const statusClass = `status-${api.status}`;
            const statusText = api.status.charAt(0).toUpperCase() + api.status.slice(1);

            let statusColor = 'var(--tech-green)';
            if (api.status === 'error') statusColor = 'var(--crimson)';
            if (api.status === 'inactive') statusColor = 'var(--muted-foreground)';

            div.innerHTML = `
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold">${api.name}</h3>
                    <div class="flex items-center">
                        <span class="status-indicator ${statusClass}"></span>
                        <span class="text-sm font-medium" style="color: ${statusColor};">${statusText}</span>
                    </div>
                </div>

                ${api.details.model ? `
                    <div class="mb-2 text-sm" style="color: var(--muted-foreground);">
                        <span class="font-medium">Model:</span> ${api.details.model}
                    </div>
                ` : ''}

                ${api.details.error ? `
                    <div class="mb-3 text-sm" style="color: var(--crimson);">
                        <span class="font-medium">Error:</span> ${api.details.error}
                    </div>
                ` : ''}

                ${api.usage && api.usage.costToday !== undefined ? `
                    <div class="mb-3 text-sm" style="color: var(--muted-foreground);">
                        <span class="font-medium">Cost Today:</span> $${api.usage.costToday.toFixed(2)}
                    </div>
                ` : ''}

                <div class="flex gap-2 mt-4">
                    <a
                        href="${api.links.docs}"
                        target="_blank"
                        class="btn-secondary text-sm py-2 px-4"
                    >
                        Docs
                    </a>
                    ${api.links.dashboard ? `
                        <a
                            href="${api.links.dashboard}"
                            target="_blank"
                            class="btn-secondary text-sm py-2 px-4"
                        >
                            Dashboard
                        </a>
                    ` : ''}
                </div>
            `;

            return div;
        }

        function renderCostSummary(apis, summary) {
            const container = document.getElementById('cost-summary');
            const items = [];

            // Add individual API costs
            Object.entries(apis).forEach(([key, api]) => {
                if (api.usage && api.usage.costToday !== undefined) {
                    const calls = api.usage.callsToday || api.usage.tokensToday || 0;
                    const unit = api.usage.tokensToday ? 'tokens' : 'calls';
                    items.push(`
                        <div class="flex justify-between" style="color: var(--muted-foreground);">
                            <span>‚Ä¢ ${api.name}:</span>
                            <span class="font-medium">$${api.usage.costToday.toFixed(2)} (${calls} ${unit})</span>
                        </div>
                    `);
                }
            });

            // Add separator and totals
            items.push(`
                <div class="border-t my-3" style="border-color: var(--glass-border);"></div>
                <div class="flex justify-between font-semibold" style="color: var(--foreground);">
                    <span>Total Today:</span>
                    <span>$${summary.totalCostToday.toFixed(2)}</span>
                </div>
                <div class="flex justify-between" style="color: var(--muted-foreground);">
                    <span>Monthly Projection:</span>
                    <span class="font-medium">$${summary.monthlyProjection.toFixed(2)}</span>
                </div>
            `);

            container.innerHTML = items.join('');
        }
    </script>
</body>
</html>
